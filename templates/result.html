<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Processing Result</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <style>
        /* Entity highlighting styles */
        mark.entity { padding: 0.2em 0.4em; margin: 0 0.2em; line-height: 1; border-radius: 0.35em; }
        mark .entity-label { font-size: 0.7em; font-weight: bold; line-height: 1; border-radius: 0.35em; text-transform: uppercase; padding-left: 0.4em; }
        mark.PERSON { background: #fce1e4; border: 1px solid #f8b4bd; } 
        mark.ORG { background: #d3f3ee; border: 1px solid #7ee2d1; } 
        mark.GPE { background: #e6f2ff; border: 1px solid #b3d7ff; } 
        mark.DATE { background: #fff5e6; border: 1px solid #ffe0b3; } 
        mark.MONEY { background: #e9f5e9; border: 1px solid #b3dfb3; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center text-gray-800 my-6">Processing Result</h1>

        <div id="loading" class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto"></div>
            <p class="mt-4 text-lg text-gray-700">Aapke document ko process kiya jaa raha hai...</p>
            <p class="text-sm text-gray-500">(Pehli baar thoda samay lag sakta hai)</p>
        </div>

        <div id="result-container" class="hidden">
            </div>
    </div>

    <script>
        // Get variables from Flask template
        const taskId = "{{ task_id }}";
        const filename = "{{ filename }}";

        function checkStatus() {
            // Fetch the status from our backend API
            fetch(`/status/${taskId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Received status:", data); // For debugging
                    const loadingDiv = document.getElementById('loading');
                    const resultContainer = document.getElementById('result-container');

                    if (data.state === 'SUCCESS') {
                        loadingDiv.style.display = 'none';
                        resultContainer.classList.remove('hidden');

                        const results = data.result;

                        // Check for processing error from the backend
                        if (results.error) {
                            resultContainer.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 text-center" role="alert"><p class="font-bold">Error</p><p>${results.error}</p></div>`;
                            return;
                        }

                        // --- YAHAN IMAGE KA NAYA URL BANAYA GAYA HAI ---
                        const imageUrl = `{{ url_for('uploaded_file', filename=filename) }}`;
                        
                        // Populate the result container with the final HTML
                        resultContainer.innerHTML = `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-white p-6 rounded-lg shadow-lg">
                                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Uploaded Image</h2>
                                    <img src="${imageUrl}" class="w-full rounded-md shadow-sm"/>
                                </div>
                                <div class="space-y-6">
                                    <div class="bg-white p-6 rounded-lg shadow-lg">
                                        <h2 class="text-2xl font-bold mb-2 text-gray-800">Summary</h2>
                                        <p class="text-gray-700 leading-relaxed">${results.summary}</p>
                                    </div>
                                    <div class="bg-white p-6 rounded-lg shadow-lg">
                                        <h2 class="text-2xl font-bold mb-2 text-gray-800">Translation</h2>
                                        <p class="text-gray-700 leading-relaxed">${results.translation}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-lg mt-6">
                                <h2 class="text-2xl font-bold mb-4 text-gray-800">Highlighted Information</h2>
                                <div class="leading-loose text-gray-700">${results.highlighted_text}</div>
                            </div>
                        `;
                    } else if (data.state === 'FAILURE') {
                        loadingDiv.style.display = 'none';
                        resultContainer.classList.remove('hidden');
                        resultContainer.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 text-center" role="alert"><p class="font-bold">Task Failed</p><p>An unexpected error occurred during processing. Please try again.</p></div>`;
                    } else {
                        // If task is still pending, check again after 2 seconds
                        setTimeout(checkStatus, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching task status:', error);
                    const loadingDiv = document.getElementById('loading');
                    const resultContainer = document.getElementById('result-container');
                    loadingDiv.style.display = 'none';
                    resultContainer.classList.remove('hidden');
                    resultContainer.innerHTML = `<div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 text-center" role="alert"><p class="font-bold">Connection Error</p><p>Could not connect to the server to check status. Please check your connection.</p></div>`;
                });
        }
        
        // Start checking the status when the page loads
        window.onload = checkStatus;
    </script>
</body>
</html>